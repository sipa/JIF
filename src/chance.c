#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>

#include "chance.h"

void static build_table(uint16_t *zero_state, uint16_t *one_state, size_t size, int factor, int max_p) {
  const int64_t one = 1LL << 32;
  int64_t p;
  int last_p8, p8, i;

  memset(zero_state,0,sizeof(uint16_t) * size);
  memset(one_state,0,sizeof(uint16_t) * size);

  last_p8 = 0;
  p = one / 2;
  for (i = 0; i < size / 2; i++) {
    p8 = (size * p + one / 2) >> 32; //FIXME try without the one
    if (p8 <= last_p8) p8 = last_p8 + 1;
    if (last_p8 && last_p8 < size && p8 <= max_p) one_state[last_p8] = p8;

    p += ((one - p) * factor + one / 2) >> 32;
    last_p8 = p8;
  }

  for (i = size - max_p; i <= max_p; i++) {
    if (one_state[i]) continue;

    p = (i * one + size / 2) / size;
    p += ((one - p) * factor + one / 2) >> 32;
    p8 = (size * p + one / 2) >> 32; //FIXME try without the one
    if (p8 <= i) p8 = i + 1;
    if (p8 > max_p) p8 = max_p;
    one_state[i] = p8;
  }

  for (i = 1; i < size; i++)
    zero_state[i] = size - one_state[size - i];

/*  for (int i=0; i<size; i++) {
    fprintf(stderr,"%i -> [%i,%i]\n",i,zero_state[i],one_state[i]);
  } */
}

#if (MULTISCALE_CHANCES == 1)

#define MAX_MULTISCALE_LEVELS 256

#if (MULTISCALE_LEVELS == MAX_MULTISCALE_LEVELS)
// the alpha values represent the factors used in the different multiscale
// averages
static uint32_t alphas[MAX_MULTISCALE_LEVELS];

// if multiscale levels equals the maximum, just use all possible values
// exponentially spread between 1.0 and 3000.0.
void static init_factors(void) {
  double step=log(3000.0)/log(2.0)/(MAX_MULTISCALE_LEVELS-1.0);
  for (int t=0; t<MAX_MULTISCALE_LEVELS; t++) {
    double tau=pow(2.0,t*step);
    alphas[t]=(uint32_t)(((1.0-expl(-1.0/tau))*4294967296.0)+0.5);
    fprintf(stderr,"tau=%g: alpha=0x%lx\n",tau,(unsigned long)(alphas[t]));
  }
}

// use the count statistics in the given chance table to output an order of
// alphas (as self-generating code), such that each initial part of it
// approximately causes uniform usage of each alpha
// TODO: combine multiple chance tables, as it's limited to a single
// image now
void static output_factors(chs_table_t *tbl) {
  int min=0;
  int max=MULTISCALE_LEVELS-1;
  uint32_t oa[MULTISCALE_LEVELS];
  int outputed[MULTISCALE_LEVELS]={};
  int count=0;
  int left=MULTISCALE_LEVELS;
  while (tbl->count[min]==0) min++;
  while (tbl->count[max]==0) max--;
  fprintf(stderr,"Calculating factors...");
  void output(int val) {
    if (outputed[val]==0) {
      if (tbl->count[val]>0) {
        oa[count]=alphas[val];
        count++;
        fprintf(stderr,".");
      }
      outputed[val]=1;
      left--;
    } else {
      fprintf(stderr,"(err=%i)",val);
    }
  }
  output(min);
  output(max);
  while (left) {
    uint32_t bestdist=0;
    int bestmin=0;
    int bestmax=0;
    int pos=min;
    while (pos<max) {
      int begin=pos;
      uint32_t dist=0;
      pos++;
      while (!outputed[pos]) {
        dist += tbl->count[pos];
        pos++;
      }
      if (dist>bestdist) {
        bestdist=dist;
        bestmin=begin;
        bestmax=pos;
      }
    }
    if (bestdist==0) break;
    pos=bestmin;
    uint32_t sum=0;
    pos++;
    while(pos<max-1) {
      if ((sum+=tbl->count[pos])>bestdist/2) break;
      pos++;
    }
    output(pos);
  }
  fprintf(stderr,"\nstatic const uint32_t alphas[]={");
  for (int i=0; i<count; i++) {
    fprintf(stderr,"%g",(double)oa[i]);
    if (i<count-1) fprintf(stderr,",");
  }
  fprintf(stderr,"};\n");
}

#else
//static const uint32_t alphas[MAX_MULTISCALE_LEVELS]={2714937127,1855796,21590903,66728412,7413105,106514140,10478104,41729744,5081644,154536134,53610361,14808157,83024800,31468986,3483142,8675949,6333940,128332124,12654046,75606698,47300557,203951463,58885392,35675766,94047111,3071053,4623799,17881424,26067561,9534590,5584795,8146883,6960985,11514860,116922432,71030141,50357314,180327910,62685268,88366071,3950501,245135590,33506680,140836325,4924204,15769017,23724167,37984644,5244115,5947593,44428377,19649020,100089021,9239337,29554783,80475310,8407260,57072137,13475351,7183492,3169265,2794299,164387337,7650051,4341711,109877739,48805148,285518438,22990693,120609957,223623543,3709472,136540575,64675496,4771639,16792101,26898887,25261851,10153668,34574286,40442237,6536419,91162830,20923221,6137730,78003381,55314351,191784837,68845961,73283013,32471914,103252233,60755844,149830100,45842100,51958541,85654236,36812186,43058031,19041256,2623791,332276342,97021591,113346113,10812893,30496923,5411776,174853162,260577854,14349874,132373756,2975884,4480536,124412038,28641651,3594527,11882728,3375207,185970177,216869333,6745365,4207184,39194272,7894563,230582101,145264850,5763342,22279836,2707704,3828091,159387120,410190395,9839267,197776890,8953217,2883663,13905751,11158365,3270616,169541181,12262333,303407934,276959225,210313815,24480974,4076824,27756639,585189062,13058253,363764189,15281050,2542478,18452249,237750805,20276138,16272536,294332358,252742534,2130583863,462185550,268647915,17328222,386315419,352964365,312752266,2313344,874357947,505177649,342471031,435457062,374878495,322372603,2463684,1348207122,696492758,535880669,2172176,398083245,476120461,1061088123,638637072,1903342123,759025196,2039621,422645434,2241650,551873246,2387331,448634113,977298116,490448053,1690401179,1181956121,2038126651,716804021,620344619,803443341,520318678,676701158,568306117,924600596,1493527858,1816328538,1120194691,1004588004,2104856,850135566,1279659514,1947720708,602531930,657419257,737644875,1976407,899176673,1649701506,1090312381,1383509600,780954783,826500455,950638308,1032515596,1992655788,1246411823,1570275450,1419498079,2084110791,1150740857,1859538985,1213845117,1915153,1773726365,1456171521,1313590710,1609656898,1531563934,1731746439};
//static const uint32_t alphas[MAX_MULTISCALE_LEVELS]={21590903,66728412,7413105,106514140,10478104,41729744,5081644,154536134,53610361,14808157,83024800,31468986,3483142,8675949,6333940,128332124,12654046,75606698,47300557,203951463,58885392,35675766,94047111,3071053,4623799,17881424,26067561,9534590,5584795,8146883,6960985,11514860,116922432,71030141,50357314,180327910,62685268,88366071,3950501,245135590,33506680,140836325,4924204,15769017,23724167,37984644,5244115,5947593,44428377,19649020,100089021,9239337,29554783,80475310,8407260,57072137,13475351,7183492,3169265,2794299,164387337,7650051,4341711,109877739,48805148,285518438,22990693,120609957,223623543,3709472,136540575,64675496,4771639,16792101,26898887,25261851,10153668,34574286,40442237,6536419,91162830,20923221,6137730,78003381,55314351,191784837,68845961,73283013,32471914,103252233,60755844,149830100,45842100,51958541,85654236,36812186,43058031,19041256,2623791,332276342,97021591,113346113,10812893,30496923,5411776,174853162,260577854,14349874,132373756,2975884,4480536,124412038,28641651,3594527,11882728,3375207,185970177,216869333,6745365,4207184,39194272,7894563,230582101,145264850,5763342,22279836,2707704,3828091,159387120,410190395,9839267,197776890,8953217,2883663,13905751,11158365,3270616,169541181,12262333,303407934,276959225,210313815,24480974,4076824,27756639,585189062,13058253,363764189,15281050,2542478,18452249,237750805,20276138,16272536,294332358,252742534,2130583863,462185550,268647915,17328222,386315419,352964365,312752266,2313344,874357947,505177649,342471031,435457062,374878495,322372603,2463684,1348207122,696492758,535880669,2172176,398083245,476120461,1061088123,638637072,1903342123,759025196,2039621,422645434,2241650,551873246,2387331,448634113,977298116,490448053,1690401179,1181956121,2038126651,716804021,620344619,803443341,520318678,676701158,568306117,924600596,1493527858,1816328538,1120194691,1004588004,2104856,850135566,1279659514,1947720708,602531930,657419257,737644875,1976407,899176673,1649701506,1090312381,1383509600,780954783,826500455,950638308,1032515596,1992655788,1246411823,1570275450,1419498079,2084110791,1150740857,1859538985,1213845117,1915153,1773726365,1456171521,1313590710,1609656898,1531563934,1731746439};

static const uint32_t alphas[MAX_MULTISCALE_LEVELS]={
                                                     21590903,
                                                     66728412,
                                                     214748365,
                                                      7413105,
                                                     106514140,
                                                     10478104,
                                                     41729744,
                                                     5081644,
                                                     154536134,
                                                     53610361,
                                                     14808157,
                                                     83024800,
                                                     31468986,
                                                     3483142,
                                                     8675949,
                                                     6333940,128332124,12654046,75606698,47300557,203951463,58885392,35675766,94047111,3071053,4623799,17881424,26067561,9534590,5584795,8146883,6960985,11514860,116922432,71030141,50357314,180327910,62685268,88366071,3950501,245135590,33506680,140836325,4924204,15769017,23724167,37984644,5244115,5947593,44428377,19649020,100089021,9239337,29554783,80475310,8407260,57072137,13475351,7183492,3169265,2794299,164387337,7650051,4341711,109877739,48805148,285518438,22990693,120609957,223623543,3709472,136540575,64675496,4771639,16792101,26898887,25261851,10153668,34574286,40442237,6536419,91162830,20923221,6137730,78003381,55314351,191784837,68845961,73283013,32471914,103252233,60755844,149830100,45842100,51958541,85654236,36812186,43058031,19041256,2623791,332276342,97021591,113346113,10812893,30496923,5411776,174853162,260577854,14349874,132373756,2975884,4480536,124412038,28641651,3594527,11882728,3375207,185970177,216869333,6745365,4207184,39194272,7894563,230582101,145264850,5763342,22279836,2707704,3828091,159387120,410190395,9839267,197776890,8953217,2883663,13905751,11158365,3270616,169541181,12262333,303407934,276959225,210313815,24480974,4076824,27756639,585189062,13058253,363764189,15281050,2542478,18452249,237750805,20276138,16272536,294332358,252742534,2130583863,462185550,268647915,17328222,386315419,352964365,312752266,2313344,874357947,505177649,342471031,435457062,374878495,322372603,2463684,1348207122,696492758,535880669,2172176,398083245,476120461,1061088123,638637072,1903342123,759025196,2039621,422645434,2241650,551873246,2387331,448634113,977298116,490448053,1690401179,1181956121,2038126651,716804021,620344619,803443341,520318678,676701158,568306117,924600596,1493527858,1816328538,1120194691,1004588004,2104856,850135566,1279659514,1947720708,602531930,657419257,737644875,1976407,899176673,1649701506,1090312381,1383509600,780954783,826500455,950638308,1032515596,1992655788,1246411823,1570275450,1419498079,2084110791,1150740857,1859538985,1213845117,1915153,1773726365,1456171521,1313590710,1609656898,1531563934,1731746439};

void static init_factors(void) { }

void static output_factors(chs_table_t *tbl) { }

#endif

#if (MULTISCALE_LEVELS > MAX_MULTISCALE_LEVELS)
#error "MULTISCALE_LEVELS is too high"
#endif

#endif


void chs_table_init(chs_table_t *tbl, int cutoff) {
  tbl->cutoff=cutoff;
#if (MULTISCALE_CHANCES == 1)
  init_factors();
  for (int i=0; i<MULTISCALE_LEVELS; i++) {
    build_table(tbl->next[i][0],tbl->next[i][1],4096,alphas[i],4096-cutoff);
//    tbl->count[i]=0;
  }
#else
  build_table(tbl->next[0],tbl->next[1],4096,214748365,4096-cutoff);
#endif
}

void chs_show_stats(FILE *f, chs_table_t *tbl) {
#if (MULTISCALE_CHANCES == 1)
/*
  for (int i=0; i<MULTISCALE_LEVELS; i++) {
    uint32_t alpha=alphas[i];
    double tau=-1.0/log(1.0-alpha/4294967296.0);
    fprintf(f,"chs[%.2f] = %i\n",tau,tbl->count[i]);
  }
  output_factors(tbl);
*/
#endif
}
