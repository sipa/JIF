#include <stdio.h>
#include <assert.h>
#include <math.h>

#include "config.h"

#include "util.h"

// table for integer 2-logs
const uint8_t log2_tab[1024] = {0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,
    5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,
    6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
    7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
    7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
    8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
    8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
    8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
    8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
    8,8,8,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,
    9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,
    9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,
    9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,
    9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,
    9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,
    9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,
    9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,
    9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,
    9,9,9,9,9,9,9,9,9,9,9,9,};

// integer 2-log (for numbers>1023)
int ilog2(uint32_t l) {
  int p = 0;
  if (l == 0) return 0;
  if (l & 0xFFF00000) {
    p = 20;
    l >>= 20;
  }
  if (l & 0xFFC00) {
    p += 10;
    l >>= 10;
  }
  p += log2_tab[l];
  return p;
}


int quantize_log_uint32(uint32_t val, int levels) {
  if (val==0 || levels==1) return 0;
  int result=32;
//  fprintf(stderr,"%i",val);
  while (val < (1UL<<31)) {
    val *= 2;
    result--;
  }
  val = val >> 22;
  assert(val >= 0);
  assert(val < 1024);

//  fprintf(stderr," : exp=%i rem=%i ",result,val);
  
  result *= 10;
  
  result += (int)(log2_tab[val]);
//  fprintf(stderr," gives %i/%i\n",result,levels);

  assert(result < levels);
  assert(result > 0);
  return result;
}

/*
int quantize_log_uint32(uint32_t val, int levels) {
  if (val==0 || levels==1) return 0;
  levels--;
  int add=0;
  fprintf(stderr,"%i",val);
  while (val < (1UL<<31)) {
    val *= 2;
    add++;
  }
  int app=(val >= 0xFFF80000) ? 4096 : (val+(1<<19))/(1<<20);
  int l=log4k[app]+add*log4k[2048]; // 0..174752 (5461 voor val=1<<31)
  int pre=((l-1)*levels)/174752;
  int result = levels-pre;
  if (result >= levels+1) result=levels;
  assert(result < levels+1);
  assert(result > 0);
  fprintf(stderr," gives %i/%i\n",result,levels);
  return result;
}
  */

int qbvar(uint32_t var, int quant) {
    int result=quantize_log_uint32(var,quant);
    if (result<0) result=0;
    return result;
}

#define swap(a,b) {int _c=(a); (a)=(b); (b)=_c; }

int median_3(int a, int b, int c) {
  if (a<b) swap(a,b); 
  if (b<c) swap(b,c); 
  if (a<b) swap(a,b); 
  return b;
}

int median5(int a, int b, int c, int d, int e) {
  if (a<b) swap(a,b); // 1
  if (c<d) swap(c,d); // 2
  if (a<c) {swap(a,c); swap(b,d);} // 3
  if (c>e) { // 4
    if (d<e) swap(d,e); // 5
    if (b>d) { // 6
      if (b>c) return c; else return b; // 7
    } else {
      return d; // 6
    } 
  } else {
    if (b>c) { // 5
      if (e>c) { // 6
        if (e>b) return b; else return e; // 7
      } else {
        return c; // 6
      }
    } else {
      return c; // 5
    }
  }
}

int median7(int a, int b, int c, int d, int e, int f, int g) {
  for(int i=0; i<6; i++) {
    if (a<b) swap(a,b); 
    if (b<c) swap(b,c); 
    if (c<d) swap(c,d); 
    if (d<e) swap(d,e); 
    if (e<f) swap(e,f); 
    if (f<g) swap(f,g); 
  }
  return d;
}
